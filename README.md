# Spring Cloud Platform

## Pre-Requisites

# Installing Spring Cloud CLI

There are a variety of ways to install Spring Cloud CLI, and you can find all of them [here](https://docs.spring.io/spring-boot/docs/current-SNAPSHOT/reference/html/getting-started.html#getting-started-manual-cli-installation).  
The easiest way, however, is to use [Homebrew](https://brew.sh/) (requires a Mac environment).

Using Homebrew simply execute these few commands:

```bash
$ brew tap pivotal/tap
$ brew install springboot
```
This installs the Spring **Boot** CLI. After that, you need to install the Spring Cloud CLI plugin like this:

```bash
$ spring install org.springframework.cloud:spring-cloud-cli:2.1.0.RELEASE
```

To check the installed Spring Boot CLI version and the available Spring Cloud services you can start up locally, run the following commands:

```bash
$ spring version      # print the version of the Spring Boot CLI
$ spring cloud --list # print the available services you can start with Spring Cloud CLI
```

To bring up a service via the CLI, you can type:

```bash
$ spring cloud eureka # bring up a Eureka service registry locally.
```

For more information see the [Spring Cloud CLI documentation](https://cloud.spring.io/spring-cloud-cli/reference/html/).

# Starting or Deploying Zipkin Server

Many of the services of this project use Spring Cloud Sleuth](https://spring.io/projects/spring-cloud-sleuth) with an integration with [Zipkin](https://zipkin.io/) to write trace logs in order to trace requests analyce latencies.

Trace logs generated by a service are sent to a Zipkin server instance expected to be running (by default) on http://localhost:9411/zipkin.
The easiest way to run a Zipkin server is to use Docker:

```bash
docker run -p 9411:9411 --name zipkinServer openzipkin/zipkin
```

... or ...

```bash
./scripts/startZipkin.sh
```

This will pull and start a Zipkin server container and once it is started you can access its UI using the link http://localhost:9411/zipkin.

As services will be making requests and logging traces, you will see them in the Zipkin UI. This allows you not only to see which requests are being sent and received but also how long they took and if they were successful or not.

Note, that Spring Cloud Sleuth and Zipkin also work for message-based communication, e.g. using RabbitMQ. See the Spring Cloud Sleuth](https://cloud.spring.io/spring-cloud-static/spring-cloud-sleuth/2.1.3.RELEASE/single/spring-cloud-sleuth.html#_sleuth_with_zipkin_over_rabbitmq_or_kafka) documentation for details.

# Starting or Deploying Message Broker

```bash
docker run -d --hostname my-rabbit --name rabbitBroker -p 15672:15672 -p 5672:5672 rabbitmq:3-management
```

... or ...

```bash
./scripts/startRabbit.sh
```

Once started you can access its UI using http://localhost:15672/#/.  
Username: guest, password: guest.

# Service Startup Order

Required startup order (ideally):
1. Zipkin server
2. RabbitMQ
3. service-registry 
4. config-server instances 
5. services (i.e. service-registry clients)

For 1. - 3. the order does not really matter. They can be started in any order and will find one another.
Services need to be started last, as they will require configuration for startup coming from the config-server.

# Config Server

[Access in Browser](http://localhost:1111/service/master_or_profile)

This project was created with [Spring Cloud Config Server](https://cloud.spring.io/spring-cloud-config/reference/html/#_spring_cloud_config_server) using the following dependencies:

* Config Server
* Zipkin Client
* Eureka Discovery Client
* Spring Boot Actuator
* Cloud Bus (Adds `spring-cloud-bus`)
* Spring for RabbitMQ (adds `spring-boot-starter-amqp`, and `spring-cloud-stream-binder-rabbit` for Spring Cloud Bus)

Project `config-server` is a Spring Boot application that acts as a central configuration server.
It uses [Spring Cloud Config Server](https://cloud.spring.io/spring-cloud-config/reference/html/#_spring_cloud_config_server) to serve configurations that are stored in a [GitHub repository](https://github.com/FWinkler79/SpringCloudPlatform-Configs).

- Has its own configurations (not loaded from github)
- Uses Zipkin / Sleuth to report tracing information.
- Is a Eureka client, i.e. registers itself with service registry.
- Services find / lookup config-server via Eureka.
- Allows more than one config-server instances to run and be addressed by one logical service name.
- config-server (and all its potential instances) need to start before any service that reads configuration is started.
  (See [this Spring Cloud Config issue](https://github.com/spring-cloud/spring-cloud-config/issues/514).)
- Configs are loaded using the following URL pattern `/{name}/{profile}/{label}` where
  - name: service ID
  - profile: active spring profile
  - label: usually `master` but can be any git tag, commit ID or branch name.
  - see [Spring Cloud Config](https://cloud.spring.io/spring-cloud-config/reference/html/) and [Locating Remote Configuration Resources](https://cloud.spring.io/spring-cloud-config/reference/html/#_locating_remote_configuration_resources)
- Uses Spring Cloud Bus, RabbitMQ and Spring Cloud Config Monitor to expose an `/monitor` endpoint which can be registered as a GitHub WebHook. Every time the configuration changes in GitHub, GitHub sends an event to the `/monitor` endpoint.
  The controller behind the `/monitor` endpoint fires a refresh event via the Spring Cloud Bus (using RabbitMQ as the signalling layer), BUT: only to the service instances that are affected by the change in GitHub (based on Eureka service registry).
  Services refresh automatically with changes in the configurations being pushed to GitHub!

## Updating Configs

Update files, push to GitHub, then refresh services that need updated configs.

Actuator endpoints:
- For debugging: `/actuator/env` and `/actuator/health`
- For Refreshing: `/actuator/refresh` - POST only. Send empty POST request. Receive list of changed properties (delta) after refresh.


# Service Registry

[Access in Browser](http://localhost:8761/)

This project was created with [Spring Cloud Config Server](https://cloud.spring.io/spring-cloud-config/reference/html/#_spring_cloud_config_server) using the following dependencies:

* Eureka Server
* Config Client
* Zipkin Client
* Spring Boot Actuator

- Currently does not use configs from config-server but brings its own.
- Startup is independent from config-server

# Reservation Service

[Access in Browser](http://localhost:2222/reservations?page=1&size=2&sort=reservationName,asc)

This project was created with [Spring Cloud Config Server](https://cloud.spring.io/spring-cloud-config/reference/html/#_spring_cloud_config_server) using the following dependencies:

* Spring Reactive Web
* Rest Repositories
* Cloud Bus (Adds `spring-cloud-bus`)
* Spring for RabbitMQ (adds `spring-boot-starter-amqp`, and `spring-cloud-stream-binder-rabbit` for Spring Cloud Bus)
* Spring Data JPA
* H2 Database
* Config Client
* Zipkin Client
* Eureka Discovery Client
* Spring Boot Actuator
* RSocket
* Spring REST Docs

# Diagnostics Service

[Access in Browser](http://localhost:8777/)

This project was created with [Spring Cloud Config Server](https://cloud.spring.io/spring-cloud-config/reference/html/#_spring_cloud_config_server) using the following dependencies:

* Eureka Discovery Client
* Zipkin Client
* Spring Boot Starter Web
* Spring Boot Actuator

Additionally references WebJars to provide static UI content.

# Technologies to use:

- Protocol:    [RSocket](http://rsocket.io/) | [FAQ](http://rsocket.io/docs/FAQ) | [Motivation](http://rsocket.io/docs/Motivations) | [Github Repos](https://github.com/rsocket)
- Gateway:     [Spring Cloud Gateway](https://github.com/spring-cloud/spring-cloud-gateway)
- Configs:     [Spring Cloud Config Server](https://cloud.spring.io/spring-cloud-config/reference/html/#_spring_cloud_config_server) in combination with Git | [Spring Cloud Bus](https://spring.io/projects/spring-cloud-bus)
- Testing:     [Spring Cloud Contract](https://spring.io/projects/spring-cloud-contract)
- Development: [Spring Cloud CLI](https://cloud.spring.io/spring-cloud-cli/reference/html/)
- Tracing:     [Spring Cloud Sleuth / Zipkin](https://spring.io/projects/spring-cloud-sleuth) | [Tutorial](https://spring.io/blog/2016/02/15/distributed-tracing-with-spring-cloud-sleuth-and-spring-cloud-zipkin) | [Baeldung Tutorial](https://www.baeldung.com/tracing-services-with-zipkin) | [Video](https://content.pivotal.io/springone-platform-2017/distributed-tracing-latency-analysis-for-your-microservices-grzejszczak-krishna) 
- Pipelines:   [Cloud Pipelines](https://github.com/CloudPipelines/) | [Why the migration](https://spring.io/blog/2018/11/13/spring-cloud-pipelines-to-cloud-pipelines-migration)
- Data Access: [Spring Data](https://spring.io/projects/spring-data)
- REST Docs:   [Spring REST Docs](https://spring.io/projects/spring-restdocs)
- Secure Password Storage: [Spring Vault](https://spring.io/projects/spring-vault) | [Vault](https://www.vaultproject.io/) | [Vault Docker Image](https://hub.docker.com/_/vault)

# References

* [Beginner's guide to Spring Cloud](https://www.youtube.com/watch?v=aO3W-lYnw-o) | [Github Repo](https://github.com/ryanjbaxter/beginners-guide-to-spring-cloud/)
* [Building Micro-Services with Spring Cloud](https://www.youtube.com/watch?v=ZyK5QrKCbwM) (great video) | [GitHub Repository](https://github.com/joshlong/bootiful-microservices)
* [Reactive Databases](https://r2dbc.io/)
* [Aeron Protocol](https://github.com/real-logic/aeron/wiki) | [Blog Post](https://medium.com/@pirogov.alexey/aeron-low-latency-transport-protocol-9493f8d504e8)
* [RSocket and Spring Cloud Gateway](https://content.pivotal.io/slides/welcome-to-the-reactive-revolution-rsocket-and-spring-cloud-gateway-spencer-gibb) | [Older Presentation](https://qconsp.com/system/files/presentation-slides/rsocket_and_spring_cloud_gateway-spencer.gibb_.pdf)
* [Spring Cloud Gateway RSocket Sample](https://github.com/spencergibb/spring-cloud-gateway-rsocket-sample)
* [Living on the Edge: Spring Cloud Gateway](https://www.youtube.com/watch?v=jOawuL1Xnwo) (Interesting approach to exposing the Gateway as a Service (broker)!)
* [Spring Tips: Spring Cloud Gateway](https://www.youtube.com/watch?v=TwVtlNX-2Hs)
* [Distributed Reactive Streams with RSocket, Reactor, and Spring](https://www.youtube.com/watch?v=WVnAbv65uCU) (great video)
* [Netifi](https://www.netifi.com/) | [Docs](https://docs.netifi.com/1.6.8/) | [Netifi Broker vs. Spring Cloud Gateway](https://community.netifi.com/t/netifi-vs-future-spring-cloud-gateway/174) | [Youtube Channel](https://www.youtube.com/channel/UCgq8KGNViXB_D-EUpQBLHzA) | [Motivation](https://www.youtube.com/watch?v=V5bhLd_DPjM) | [Spring Demo Repo](https://github.com/netifi/spring-demo)
* [Understanding Reactive Types](https://spring.io/blog/2016/04/19/understanding-reactive-types)
* [Reactive Streams](https://www.reactive-streams.org)
* [Project Reactor](https://projectreactor.io/)
* [RxJava]()
* [Spring Boot CLI Installation](https://docs.spring.io/spring-boot/docs/current-SNAPSHOT/reference/html/getting-started.html#getting-started-manual-cli-installation)
* [Distributed Tracing with Zipkin](https://www.youtube.com/watch?v=f9J1Av8rwCE)
* [Open Tracing Initiative](https://github.com/opentracing)
* [Spring Cloud Bus](https://spring.io/projects/spring-cloud-bus) | [Baeldung Tutorial](https://www.baeldung.com/spring-cloud-bus)